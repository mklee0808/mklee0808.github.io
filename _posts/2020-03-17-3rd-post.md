---
title: "Node.js의 핵심 개념"
---

# Node.js

#### 1.1 Node.js의 핵심 개념

##### 1.1.1 Node.js란?

Node.js®는 `Chrome V8 JavaScript` 엔진으로 빌드된 `JavaScript` 런타임입니다. 

Node.js는 **이벤트 기반**, **논블로킹 I/O** 모델을 사용해 가볍고 효율적입니다. Node.js의 패키지 생태계인 npm은 세계에서 가장 큰 오픈 소스 라이브러리 생태계이기도 합니다.

##### 1.1.2 자바스크립트 런타임

​	노드는 **자바스크립트 런타임**. 런타임은 특정 언어로 만든 프로그램들을 실행할 수 있는 환경을 뜻함. 따라서 노	드는 자바스크립트 프로그램을 컴퓨터에서 실행할 수 있게 해준다.

​                                                                                [노드의 내부 구조]

<img src="https://thebook.io/img/006982/023.jpg" alt="023" style="zoom: 33%;" />

##### 1.1.3 이벤트 기반

**이벤트 기반*(event-driven)***이란 이벤트가 발생할 때 미리 지정해둔 작업을 수행하는 방식을 의미

이벤트 기반 시스템에서는 특정 이벤트가 발생할 때 무엇을 할지 미리 등록해두어야 한다. 이것을 **이벤트 리스너*(event listener)***에 **콜백*(callback)*** 함수를 등록한다고 표현한다.

> ex) 버튼을 누르면 경고 창을 띄운다 --> 버튼: 이벤트 리스너,      경고 창을 띄우는 함수 : 콜백 함수

- **이벤트 루프** : 이벤트 발생 시 호출할 콜백 함수들을 관리하고, 호출된 콜백 함수의 실행 순서를 결정하는 역할을 담당한다. 노드가 종료될 때까지 이벤트 처리를 위한 작업을 반복하므로 루프라고 불린다.

- **태스크 큐** : 이벤트 발생 후 호출되어야 할 콜백 함수들이 기다리는 공간. 콜백들이 이벤트 루프가 정한 순서대로 줄을 서 있으므로 콜백 큐라고도 부른다.

- **백그라운드**: 타이머나 I/O 작업 콜백 또는 이벤트 리스너들이 대기하는 곳.

  <img src="https://thebook.io/img/006982/026.jpg" alt="026" style="zoom:65%;" />

<img src="https://thebook.io/img/006982/027_1.jpg" alt="027_1" style="zoom:65%;" />

<img src="https://thebook.io/img/006982/027_2.jpg" alt="027_2" style="zoom:65%;" />

> 만약 호출 스택에 함수들이 너무 많이 차 있으면 3초가 지난 후에도 run 함수가 실행되지 않을 수도 있습니다. 이벤트 루프는 호출 스택이 비어 있을 때만 태스크 큐에 있는 run 함수를 호출 스택으로 가져오니까요. 이것이 setTimeout의 시간이 정확하지 않을 수도 있는 이유입니다.

##### 1.1.4 논블로킹 I/O

이벤트 루프를 잘 활용하면 오래 걸리는 작업을 효율적으로 처리할 수 있습니다. 오래 걸리는 함수를 백그라운드로 보내서 다음 코드가 먼저 실행되게 하고, 그 함수가 다시 태스크 큐를 거쳐 호출 스택으로 올라오기를 기다리는 방식입니다. 이 방식이 논블로킹 방식입니다. 논블로킹이란 이전 작업이 완료될 때까지 멈추지 않고 다음 작업을 수행함을 뜻합니다.

<img src="https://thebook.io/img/006982/028.jpg" alt="028" style="zoom: 50%;" />

그림을 보면 블로킹보다 논블로킹 방식이 같은 작업을 더 짧은 시간 동안 처리할 수 있음을 알 수 있습니다. 하지만 싱글 스레드라는 한계 때문에 자바스크립트의 모든 코드가 이 방식으로 시간적 이득을 볼 수 있는 것은 아닙니다. 현재 노드 프로세스 외의 다른 컴퓨팅 자원을 사용할 수 있는 I/O 작업이 주로 시간적 이득을 많이 봅니다.

I/O는 입력(Input)/출력(Output)을 의미합니다. 파일 시스템 접근(파일 읽기, 쓰기, 폴더 만들기 등)이나 네트워크 요청 같은 작업이 I/O의 일종입니다. 이러한 작업을 할 때 노드는 논블로킹 방식으로 동작합니다.

  다음 예제는 블로킹 방식의 코드입니다. 콘솔 결과를 미리 예측해보세요.

```javascript
function longRunningTask() {
  // 오래 걸리는 작업
  console.log('작업 끝');
}
console.log('시작');
longRunningTask();
console.log('다음 작업');
```

------

시작

작업 끝

다음 작업

------

이번에는 setTimeout을 사용해서 코드를 바꿔보겠습니다. 논블로킹 방식의 코드입니다.

```javascript
function longRunningTask() {
  // 오래 걸리는 작업
  console.log('작업 끝');
}
console.log('시작');
setTimeout(longRunningTask, 0);
console.log('다음 작업');
```

------

시작

다음 작업

작업 끝

------

setTimeout(콜백, 0)은 코드를 논블로킹으로 만들기 위해 사용하는 기법 중 하나입니다. 노드에서는 setTimeout(콜백, 0) 대신 다른 방식을 주로 사용합니다(3.4.3절 참조). 이벤트 루프를 이해했다면 setTimeout의 콜백 함수가 태스크 큐로 보내지므로 순서대로 실행되지 않는다는 것을 알 수 있습니다.

> **setTimeout(콜백, 0)**
>
> 밀리초를 0으로 설정했으므로 바로 실행되는 것이 아닌가 착각할 수 있습니다. 하지만 브라우저와 노드에서는 기본적인 지연 시간이 있으므로 바로 실행되지 않습니다. HTML5 브라우저에서는 4ms, 노드에서는 1ms의 지연 시간이 있습니다.

##### 1.1.5 싱글 스레드

자바스크립트와 노드에서 논블로킹이 중요한 이유는 바로 싱글 스레드이기 때문입니다. 한 번에 한 가지 일밖에 처리하지 못하므로 어떠한 작업에서 블로킹이 발생하면 다음 일을 처리하지 못합니다. 

**싱글 스레드 - 논블로킹 모델**

바로 노드가 채택하고 있는 방식입니다. 점원은 한 명이지만 혼자서 많은 일을 처리할 수 있습니다. 하지만 그 점원 한 명이 아파서 쓰러지거나 하면 큰 문제가 생길 수 있습니다. 또한, 주문을 받거나 서빙을 하는 데 시간이 오래 걸린다면 주문이 많이 들어 왔을 때 버거울 수 있습니다.

<img src="https://thebook.io/img/006982/031_1.jpg" alt="031_1" style="zoom:67%;" />

**멀티 스레드 - 블로킹 모델**

멀티 스레드 방식에서는 손님이 올 때마다 점원이 한 명씩 맡아 주문을 받고 서빙합니다. 언뜻 보면 싱글 스레드보다 좋은 방법인 것 같지만 손님의 수가 늘어날수록 점원의 수도 늘어납니다. 손님 수가 줄어들었을 때 일을 하지 않고 노는 점원이 있다는 것도 문제가 됩니다. 점원을 새로 고용하거나 기존 직원을 해고하는 데는 비용이 발생합니다.

<img src="https://thebook.io/img/006982/031_2.jpg" alt="img" style="zoom:42%;" />



그렇다면 점원 여러 명(멀티 스레드)이 모두 논블로킹 방식으로 주문을 받으면 더 좋지 않을까 하는 의문이 들 수 있습니다. 실제로 그렇습니다. 노드도 싱글 스레드 여러 개를 사용해 멀티 스레딩과 비슷한 기능을 하게 할 수 있습니다. 하지만 엄밀히 말하면 멀티 스레딩이라기보다는 멀티 프로세싱에 가깝습니다. 그럼 프로세스와 스레드의 차이에 대해 알아봅시다.

-  **프로세스**는 운영체제에서 할당하는 작업의 단위입니다. 노드나 인터넷 브라우저 같은 프로그램은 개별적인 프로세스입니다. 프로세스 간에는 메모리 등의 자원을 공유하지 않습니다.
- **스레드**는 프로세스 내에서 실행되는 흐름의 단위입니다. 하나의 프로세스는 스레드를 여러 개 가질 수 있습니다. 스레드들은 부모 프로세스의 자원을 공유합니다. 즉, 같은 메모리에 접근할 수 있습니다.

노드는 스레드를 늘리는 대신, 프로세스 자체를 복사해 여러 작업을 동시에 처리하는 멀티 프로세싱 방식을 택했습니다. 자바스크립트 언어 자체가 싱글 스레드 특성을 띠고 있기 때문입니다. 





